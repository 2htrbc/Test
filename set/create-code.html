<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Create & Manage Login Codes</title>
<style>
body {
  background: #121212; color: white; font-family: Arial, sans-serif; padding: 20px; text-align: center;
}
h2 { color: #00ffd5; margin-bottom: 20px; font-size: 26px; text-shadow: 0 0 8px #00ffd5; }
input, select { padding: 12px; font-size: 16px; border-radius: 8px; border: none; margin: 5px; width: 220px; background: #1f1f1f; color: white; outline: none; }
button { padding: 10px 16px; margin: 5px; background: #00ffd5; color: black; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; }
button:hover { background: #00c0a8; }
#message { margin: 15px 0; font-weight: bold; }
.code-list { margin-top: 20px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto; }
.code-item { background: #1e1e1e; padding: 12px 16px; margin-bottom: 10px; border-radius: 8px; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
.countdown { font-size: 12px; color: #ccc; }
</style>
</head>
<body>
<h2>HONOR TV PANEL</h2>
<input type="text" id="code" placeholder="Enter new code" maxlength="30">
<select id="duration">
  <option value="7">7 Days</option>
  <option value="15">15 Days</option>
  <option value="30">1 Month</option>
  <option value="60">2 Months</option>
  <option value="180">6 Months</option>
  <option value="365">1 Year</option>
  <option value="730">2 Years</option>
  <option value="lifetime">Lifetime</option>
</select>
<button id="createBtn">Add Code</button>
<div id="message"></div>
<div class="code-list" id="codeList"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

const firebaseConfig = {  
  apiKey: "AIzaSyCR1uCuyGSoVcPlmocqPAyZsQeNbiZoZWQ",
  authDomain: "appcode-a1290.firebaseapp.com",
  projectId: "appcode-a1290",
  storageBucket: "appcode-a1290.firebasestorage.app",
  messagingSenderId: "538238847885",
  appId: "1:538238847885:web:b62567a298a9ac91cc8bc4",
  measurementId: "G-2H7L7SF1X6"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const codeInput = document.getElementById("code");
const durationSelect = document.getElementById("duration");
const messageEl = document.getElementById("message");
const codeList = document.getElementById("codeList");

const showMessage = (msg, color="#00ff99") => { 
  messageEl.textContent = msg; 
  messageEl.style.color = color; 
};

async function createCode() {
  const code = codeInput.value.trim();
  const duration = durationSelect.value; // store as string

  if(code.length < 4) { 
    showMessage("‚ö†Ô∏è Code must be at least 4 characters", "#ff6666"); 
    return; 
  }

  try {
    await setDoc(doc(db, "codes", code), { duration, createdAt: serverTimestamp() });
    showMessage(`‚úÖ Code "${code}" created for ${duration}${duration==="lifetime"?" (Lifetime)":" days"}`);
    codeInput.value = "";
  } catch(e) { 
    console.error(e); 
    showMessage("‚ùå Failed to create code", "#ff4444"); 
  }
}

async function deleteCode(code) {
  try { 
    await deleteDoc(doc(db, "codes", code)); 
    showMessage(`üóëÔ∏è Code "${code}" deleted`, "#ffcc00"); 
  } catch(e) { 
    console.error(e); 
    showMessage("‚ùå Failed to delete code", "#ff4444"); 
  }
}

function getRemainingTime(expiryDate) {
  const now = new Date(); 
  const diff = expiryDate - now; 
  if(diff<=0) return null;
  const seconds = Math.floor(diff/1000), minutes=Math.floor(seconds/60), hours=Math.floor(minutes/60), days=Math.floor(hours/24);
  return {days:days, hours:hours%24, minutes:minutes%60, seconds:seconds%60};
}

function startCountdown(code, expiryDate) {
  const countdownEl = document.getElementById(`countdown-${code}`);
  const interval = setInterval(()=>{
    const t = getRemainingTime(expiryDate);
    if(!t){ 
      clearInterval(interval); 
      countdownEl.textContent="‚õî Expired - Deleting..."; 
      setTimeout(()=>deleteCode(code),2000); 
    }
    else countdownEl.textContent=`‚è≥ ${t.days}d ${t.hours}h ${t.minutes}m ${t.seconds}s`;
  },1000);
}

document.getElementById("createBtn").addEventListener("click", createCode);
document.addEventListener("keydown", e=>{ if(e.key==="Enter") createCode(); });

onSnapshot(collection(db,"codes"), snapshot=>{
  codeList.innerHTML="";
  snapshot.forEach(docSnap=>{
    const data = docSnap.data(); const code=docSnap.id;
    if(!data.createdAt) return;
    const createdAt = data.createdAt.toDate();
    let expiry;
    if(data.duration==="lifetime") expiry=null; 
    else { expiry=new Date(createdAt); expiry.setDate(expiry.getDate()+parseInt(data.duration)); }

    const codeItem = document.createElement("div");
    codeItem.className="code-item";
    codeItem.innerHTML=`
      <div>
        <div><strong>${code}</strong> (${data.duration}${data.duration==="lifetime"?" (Lifetime)":" days"})</div>
        <div>Created: ${createdAt.toLocaleString()}</div>
        <div class="countdown" id="countdown-${code}">‚è≥ Checking...</div>
      </div>
      <button onclick="deleteCode('${code}')">Delete</button>
    `;
    codeList.appendChild(codeItem);
    if(expiry) startCountdown(code,expiry); 
    else document.getElementById(`countdown-${code}`).textContent="‚ôæÔ∏è Lifetime";
  });
});

window.deleteCode = deleteCode;
</script>
</body>
</html>
